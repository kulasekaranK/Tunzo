<ion-footer class="music-player-footer">
    <ion-toolbar class="player-controls-toolbar" (click)=" openModal()">

        <div class="player-progress-container ion-margin-bottom">
            <ion-progress-bar [value]="player.getCurrentTime() / player.getDuration()" color="primary" class="player-progress-bar" [class.player-active]="player.isPlayingSong()">
            </ion-progress-bar>

            <div class="player-time-display">
                <span class="current-time">{{ player.formatTime(player.getCurrentTime()) }}</span>
                <span class="total-time">{{ player.formatTime(player.getDuration()) }}</span>
            </div>
        </div>

        <div class="player-main-container">
            <div class="player-album-art" [class.player-album-spin]="player.isPlayingSong()">
                @if (player.getCurrentSong()) {
                <img [src]="player.getCurrentSong()?.imageUrl || player.getCurrentSong()?.image[1]?.url" alt="Now Playing" class="album-image"> }
                <div class="album-art-overlay"></div>
            </div>

            <div class="player-primary-controls">
                <button class="player-nav-button" (click)="$event.stopPropagation(); player.prev()">
                    <svg class="player-nav-icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M6 18V6h2v12H6m3.5-6L18 6v12l-8.5-6z" />
                    </svg>
                </button>

                <button class="player-play-button" (click)="$event.stopPropagation(); player.togglePlayPause()">
                    <svg class="player-play-icon" viewBox="0 0 24 24">
                        @if (player.isPlayingSong()) {
                        <path fill="currentColor" d="M14,19H18V5H14M6,19H10V5H6V19Z" />
                        } @else {
                        <path fill="currentColor" d="M8,5.14V19.14L19,12.14L8,5.14Z" />
                        }
                    </svg>
                </button>

                <button class="player-nav-button" (click)="$event.stopPropagation(); player.next()">
                    <svg class="player-nav-icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M16 18h2V6h-2v12m-3.5-6L6 6v12l6.5-6z" />
                    </svg>
                </button>
            </div>

                        <div class="player-secondary-controls">
                            <button class="player-action-button" (click)="$event.stopPropagation(); toggleLikeSong(player.getCurrentSong())">
                              <span class="material-icons"
                                    [style.color]="isLiked() ? 'var(--ion-color-danger)' : 'currentColor'">
                                favorite
                              </span>
                            </button>
            
                            <button class="player-action-button" (click)="$event.stopPropagation(); openAddToPlaylistModal()">
                              <span class="material-icons">playlist_add</span>
                            </button>
                        </div>        </div>
    </ion-toolbar>
</ion-footer>

<ion-modal #modal class="ion-margin-top ion-padding-top" [isOpen]="isModalOpen" [initialBreakpoint]="1" [breakpoints]="[0, 1]" (ionModalDidDismiss)="onModalDismiss()" swipeToClose="true">
    <ng-template>
        <ion-content>

            <div class="player-view">
                <!-- Album Info Section -->
                <div class="album-info">
                    <h1 class="album-title" [innerHTML]="sanitizeHtml(player.getCurrentSong()?.album?.name || player.getCurrentSong()?.album )"></h1>
                    <p class="album-label" [innerHTML]="sanitizeHtml(player.getCurrentSong()?.label || player.getCurrentSong()?.artists[0])"></p>
                </div>

                <!-- Album Art -->
                <div class="album-art-container">
                    <img [src]="player.getCurrentSong()?.imageUrl || player.getCurrentSong()?.image[2]?.url" alt="Album Cover" class="album-art" [class.art-elevated]="player.isPlayingSong()">
                    <div class="art-shadow"></div>
                </div>

                <!-- Song Info -->
                <div class="song-info">
                    <h2 class="song-title" [innerHTML]="sanitizeHtml(player.getCurrentSong()?.name)"></h2>
                    <p class="song-year">{{player.getCurrentSong()?.year}}</p>
                </div>

                <!-- Controls -->
                <div class="player-controls">
                    <!-- Top Controls -->
                    <div class="player-controls-container">
                        <!-- Secondary Controls -->
                        <div class="secondary-controls">
                            <button class="control-icon" (click)="player.toggleShuffle()" [class.active]="player.getShuffleStatus()">
                                <div class="icon-wrapper">
                                    <span class="material-icons">
                                        {{ player.getShuffleStatus() ? 'shuffle_on' : 'shuffle' }}
                                    </span>
                                </div>
                                <div class="control-ripple"></div>
                            </button>

                            <button class="control-icon" (click)="toggleLikeSong(player.getCurrentSong())" [class.active]="isLiked()">
                                <div class="icon-wrapper">
                                    <span class="material-icons">
                                        {{ isLiked() ? 'favorite' : 'favorite' }}
                                    </span>
                                </div>
                                <div class="control-ripple"></div>
                            </button>
                        </div>

                        <div class="progress-section">
                            <div class="progress-bar-container">
                                <!-- Background Track -->
                                <div class="progress-bg-track"></div>

                                <!-- Highlight Progress -->
                                <div class="progress-highlight" [style.width.%]="player.getDuration() ? (player.getCurrentTime() / player.getDuration()) * 100 : 0">
                                </div>

                                <!-- Interactive Range -->
                                <ion-range class="premium-range" [min]="0" [max]="player.getDuration()" [step]="1" [value]="player.getCurrentTime()" (ionChange)="player.seek($any($event.detail.value))">
                                </ion-range>

                            </div>

                            <div class="time-display">
                                <span class="current-time">{{ player.formatTime(player.getCurrentTime()) }}</span>
                                <span class="duration">{{ player.formatTime(player.getDuration()) }}</span>
                            </div>
                        </div>

                    </div>

                    <!-- Main Controls -->
                    <div class="primary-controls">
                        <button class="nav-btn" (click)="player.prev()">
                            <span class="material-icons">skip_previous</span>
                        </button>

                        <button class="play-btn" (click)="player.togglePlayPause()">
                            <span class="material-icons">
                                {{player.isPlayingSong() ? "pause" : "play_arrow"}}
                            </span>
                        </button>

                        <button class="nav-btn" (click)="player.next()">
                            <span class="material-icons">skip_next</span>
                        </button>
                    </div>
                </div>

                <!-- Stream Quality -->
                <div class="stream-info">
                    <ion-text>
                        <p class="stream-quality">Now Streaming in: {{stramQuality.label}}</p>
                    </ion-text>
                </div>
            </div>
            @if(player.getCurrentSong()?.artists?.primary?.length > 0) {
            <ion-card class="ion-no-padding ion-no-margin" style="width: 100%;">
                <ion-card-header>
                    <ion-label class="ion-text-center">Artists</ion-label>
                </ion-card-header>

                <ion-card-content>
                    <div class="artist-container">
                        @for (artist of player.getCurrentSong()?.artists?.primary; track $index) {

                        <img [src]="artist?.image[1]?.url" alt="{{ artist.name }}"> }
                    </div>

                </ion-card-content>
            </ion-card>
            } @if(player.getQueue().length > 0) {
            <ion-card class="ion-no-padding ion-no-margin ion-margin-top rounded-xl shadow-md" style="width: 100%;">
                <ion-card-header class="bg-white border-b border-gray-200">
                    <ion-label class="ion-text-center">Up Next</ion-label>
                </ion-card-header>

                <ion-card-content class="ion-no-padding bg-white">
                    <ion-list lines="inset" class="rounded-lg">
                        <ion-reorder-group [disabled]="false" (ionItemReorder)="handleReorder($event)" class="queue-list">
                            @for (qSong of queue(); let i = $index; track $index) {
                            <ion-item button (click)="player.play(qSong)" class="px-2 py-1 hover:bg-gray-100 transition-all duration-150">

                                <!-- Song Thumbnail -->
                                <ion-thumbnail slot="start" class="rounded-md overflow-hidden">
                                    <img [src]="qSong.imageUrl || qSong.image[1]?.url" alt="Album Art">
                                </ion-thumbnail>

                                <!-- Song Info -->
                                <ion-label class="pl-2">
                                    <h2 class="text-base font-medium text-gray-800 truncate">{{ qSong.name }}</h2>
                                    <p class="text-sm text-gray-500 truncate">{{ qSong.album.name }} • {{ qSong.year }}
                                    </p>
                                </ion-label>

                                <!-- Drag Handle (SVG) -->
                                <ion-reorder slot="end">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="text-gray-400" viewBox="0 0 16 16">
                                        <path
                                            d="M4 9.5a.5.5 0 0 1 .5-.5H11a.5.5 0 0 1 0 1H4.5a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5H11a.5.5 0 0 1 0 1H4.5a.5.5 0 0 1-.5-.5z" />
                                    </svg>
                                </ion-reorder>

                            </ion-item>
                            }
                        </ion-reorder-group>
                    </ion-list>
                </ion-card-content>
            </ion-card>


            }
        </ion-content>
    </ng-template>
</ion-modal>